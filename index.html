<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuMatch - Portal de Asignaciones</title>
    
    <!-- Favicon TuMatch -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- NextUI/HeroUI -->
    <link href="https://unpkg.com/@nextui-org/theme@latest/dist/components/button.css" rel="stylesheet">
    <link href="https://unpkg.com/@nextui-org/theme@latest/dist/components/card.css" rel="stylesheet">
    <link href="https://unpkg.com/@nextui-org/theme@latest/dist/components/input.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Brand colors
                        'brand': {
                            'coral': '#FF6B47',
                            'magenta': '#E91E63',
                            'navy': '#0F172A',
                            'navy-light': '#1E293B',
                            'blue': '#3B82F6',
                            'teal': '#0D9488',
                            'emerald': '#059669',
                            'amber': '#F59E0B',
                            'purple': '#8B5CF6',
                            'rose': '#F43F5E'
                        },
                        // Background gradients
                        'bg-gradient': {
                            'primary': 'linear-gradient(135deg, #FF6B47 0%, #E91E63 100%)',
                            'blue': 'linear-gradient(135deg, #3B82F6 0%, #0D9488 100%)',
                            'emerald': 'linear-gradient(135deg, #059669 0%, #0D9488 100%)',
                            'amber': 'linear-gradient(135deg, #F59E0B 0%, #FF6B47 100%)',
                            'purple': 'linear-gradient(135deg, #8B5CF6 0%, #E91E63 100%)',
                            'rose': 'linear-gradient(135deg, #F43F5E 0%, #FF6B47 100%)'
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif']
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                        'gradient-conic': 'conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            animation: bodyBreathe 20s ease-in-out infinite;
        }
        
        @keyframes bodyBreathe {
            0% {
                background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
            }
            25% {
                background: linear-gradient(135deg, #1A202C 0%, #2D3748 50%, #4A5568 100%);
            }
            50% {
                background: linear-gradient(135deg, #1E293B 0%, #374151 50%, #4B5563 100%);
            }
            75% {
                background: linear-gradient(135deg, #1A202C 0%, #2D3748 50%, #4A5568 100%);
            }
            100% {
                background: linear-gradient(135deg, #0F172A 0%, #1E293B 50%, #334155 100%);
            }
        }
        
        /* Dynamic background effects - SUPER ENHANCED */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 120%;
            height: 120%;
            background: 
                radial-gradient(800px circle at 25% 25%, rgba(255, 107, 71, 0.25) 0%, transparent 60%),
                radial-gradient(1000px circle at 75% 75%, rgba(233, 30, 99, 0.2) 0%, transparent 60%),
                radial-gradient(600px circle at 50% 10%, rgba(59, 130, 246, 0.15) 0%, transparent 60%),
                radial-gradient(500px circle at 90% 40%, rgba(13, 148, 136, 0.12) 0%, transparent 60%),
                radial-gradient(700px circle at 10% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 60%),
                radial-gradient(400px circle at 60% 30%, rgba(245, 158, 11, 0.08) 0%, transparent 60%);
            animation: backgroundFloat 25s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            pointer-events: none;
            z-index: -1;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 120%;
            height: 120%;
            background: 
                radial-gradient(450px circle at 80% 20%, rgba(244, 63, 94, 0.12) 0%, transparent 60%),
                radial-gradient(600px circle at 20% 60%, rgba(5, 150, 105, 0.15) 0%, transparent 60%),
                radial-gradient(350px circle at 60% 90%, rgba(139, 92, 246, 0.1) 0%, transparent 60%),
                radial-gradient(500px circle at 30% 10%, rgba(255, 107, 71, 0.08) 0%, transparent 60%),
                radial-gradient(750px circle at 85% 85%, rgba(233, 30, 99, 0.12) 0%, transparent 60%);
            animation: backgroundFloat2 30s cubic-bezier(0.4, 0, 0.6, 1) infinite reverse;
            pointer-events: none;
            z-index: -1;
        }
        
        @keyframes backgroundFloat {
            0% {
                transform: translateX(-30px) translateY(-20px) scale(1) rotate(0deg);
                opacity: 0.6;
            }
            16.66% {
                transform: translateX(-10px) translateY(-10px) scale(1.05) rotate(60deg);
                opacity: 0.7;
            }
            33.33% {
                transform: translateX(20px) translateY(-15px) scale(1.08) rotate(120deg);
                opacity: 0.8;
            }
            50% {
                transform: translateX(25px) translateY(10px) scale(1.1) rotate(180deg);
                opacity: 0.85;
            }
            66.66% {
                transform: translateX(10px) translateY(25px) scale(1.06) rotate(240deg);
                opacity: 0.75;
            }
            83.33% {
                transform: translateX(-15px) translateY(15px) scale(1.03) rotate(300deg);
                opacity: 0.7;
            }
            100% {
                transform: translateX(-30px) translateY(-20px) scale(1) rotate(360deg);
                opacity: 0.6;
            }
        }
        
        @keyframes backgroundFloat2 {
            0% {
                transform: translateX(20px) translateY(25px) scale(1.05) rotate(0deg);
                opacity: 0.5;
            }
            20% {
                transform: translateX(-5px) translateY(5px) scale(1.02) rotate(-72deg);
                opacity: 0.6;
            }
            40% {
                transform: translateX(-25px) translateY(-10px) scale(0.98) rotate(-144deg);
                opacity: 0.7;
            }
            60% {
                transform: translateX(-15px) translateY(-30px) scale(1.08) rotate(-216deg);
                opacity: 0.65;
            }
            80% {
                transform: translateX(10px) translateY(-5px) scale(1.04) rotate(-288deg);
                opacity: 0.6;
            }
            100% {
                transform: translateX(20px) translateY(25px) scale(1.05) rotate(-360deg);
                opacity: 0.5;
            }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1E293B;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #FF6B47, #E91E63);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #E91E63, #8B5CF6);
        }

        /* Floating particles animation */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fadeInUp {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        .animate-pulse-custom {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Floating particles for extra dynamism */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(255, 107, 71, 0.1), rgba(233, 30, 99, 0.1));
            animation: particleFloat 15s linear infinite;
        }
        
        .particle:nth-child(1) {
            width: 6px;
            height: 6px;
            left: 10%;
            top: -10px;
            animation-delay: 0s;
            animation-duration: 18s;
        }
        
        .particle:nth-child(2) {
            width: 4px;
            height: 4px;
            left: 25%;
            top: -10px;
            animation-delay: 3s;
            animation-duration: 22s;
        }
        
        .particle:nth-child(3) {
            width: 8px;
            height: 8px;
            left: 40%;
            top: -10px;
            animation-delay: 6s;
            animation-duration: 16s;
        }
        
        .particle:nth-child(4) {
            width: 5px;
            height: 5px;
            left: 60%;
            top: -10px;
            animation-delay: 9s;
            animation-duration: 20s;
        }
        
        .particle:nth-child(5) {
            width: 7px;
            height: 7px;
            left: 75%;
            top: -10px;
            animation-delay: 12s;
            animation-duration: 24s;
        }
        
        .particle:nth-child(6) {
            width: 3px;
            height: 3px;
            left: 90%;
            top: -10px;
            animation-delay: 15s;
            animation-duration: 19s;
        }
        
        .particle:nth-child(7) {
            width: 10px;
            height: 10px;
            left: 15%;
            top: -10px;
            animation-delay: 2s;
            animation-duration: 25s;
            background: linear-gradient(45deg, rgba(59, 130, 246, 0.15), rgba(13, 148, 136, 0.1));
        }
        
        .particle:nth-child(8) {
            width: 4px;
            height: 4px;
            left: 35%;
            top: -10px;
            animation-delay: 7s;
            animation-duration: 17s;
            background: linear-gradient(45deg, rgba(139, 92, 246, 0.12), rgba(244, 63, 94, 0.1));
        }
        
        .particle:nth-child(9) {
            width: 6px;
            height: 6px;
            left: 55%;
            top: -10px;
            animation-delay: 11s;
            animation-duration: 21s;
            background: linear-gradient(45deg, rgba(245, 158, 11, 0.15), rgba(255, 107, 71, 0.12));
        }
        
        .particle:nth-child(10) {
            width: 8px;
            height: 8px;
            left: 70%;
            top: -10px;
            animation-delay: 14s;
            animation-duration: 23s;
            background: linear-gradient(45deg, rgba(5, 150, 105, 0.12), rgba(233, 30, 99, 0.1));
        }
        
        @keyframes particleFloat {
            0% {
                transform: translateY(-10px) translateX(0px) rotate(0deg) scale(0.5);
                opacity: 0;
            }
            5% {
                opacity: 1;
                transform: translateY(5vh) translateX(10px) rotate(18deg) scale(1);
            }
            25% {
                transform: translateY(25vh) translateX(-20px) rotate(90deg) scale(1.2);
                opacity: 0.8;
            }
            50% {
                transform: translateY(50vh) translateX(30px) rotate(180deg) scale(0.9);
                opacity: 1;
            }
            75% {
                transform: translateY(75vh) translateX(-15px) rotate(270deg) scale(1.1);
                opacity: 0.7;
            }
            95% {
                opacity: 0.5;
            }
            100% {
                transform: translateY(110vh) translateX(40px) rotate(360deg) scale(0.3);
                opacity: 0;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        /* Custom card animations */
        .card-gradient {
            background: linear-gradient(135deg, #1E293B 0%, #374151 100%);
        }
        
        .icon-gradient-1 {
            background: linear-gradient(135deg, #FF6B47 0%, #E91E63 100%);
        }
        
        .icon-gradient-2 {
            background: linear-gradient(135deg, #3B82F6 0%, #0D9488 100%);
        }
        
        .icon-gradient-3 {
            background: linear-gradient(135deg, #059669 0%, #0D9488 100%);
        }
        
        .icon-gradient-4 {
            background: linear-gradient(135deg, #F59E0B 0%, #FF6B47 100%);
        }
        
        .icon-gradient-5 {
            background: linear-gradient(135deg, #8B5CF6 0%, #E91E63 100%);
        }
        
        .icon-gradient-6 {
            background: linear-gradient(135deg, #F43F5E 0%, #FF6B47 100%);
        }

        /* Empty state styles */
        .empty-state {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Notification styles */
        .update-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #059669 0%, #0D9488 100%);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(12px);
        }
        
        .update-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                font-size: 13px;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">
    <!-- Floating Particles -->
    <div class="floating-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    <!-- Hero Header -->
    <header class="relative overflow-hidden bg-gradient-to-br from-slate-900 via-slate-800 to-gray-700">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-10">
            <div class="absolute top-20 left-20 w-32 h-32 bg-gradient-to-br from-brand-coral to-brand-magenta rounded-full animate-pulse-custom"></div>
            <div class="absolute top-40 right-32 w-24 h-24 bg-gradient-to-br from-brand-blue to-brand-teal rounded-full animate-float"></div>
            <div class="absolute bottom-20 left-1/3 w-20 h-20 bg-gradient-to-br from-brand-purple to-brand-rose rounded-full animate-pulse-custom" style="animation-delay: 1s;"></div>
            <div class="absolute top-32 left-1/2 w-16 h-16 bg-gradient-to-br from-brand-emerald to-brand-amber rounded-full animate-float" style="animation-delay: 2s;"></div>
        </div>
        
        <!-- Content -->
        <div class="relative z-10 max-w-7xl mx-auto px-6 py-12 lg:py-16">
            <div class="text-center">
                <h1 class="text-3xl lg:text-5xl font-black mb-4 bg-gradient-to-r from-white via-gray-100 to-gray-300 bg-clip-text text-transparent animate-fadeInUp">
                    Portal de 
                    <span class="bg-gradient-to-r from-brand-coral to-brand-magenta bg-clip-text text-transparent animate-pulse-custom">
                        Asignaciones
                    </span>
                </h1>
                <p class="text-lg lg:text-xl text-gray-300 font-medium animate-fadeInUp" style="animation-delay: 0.2s;">
                    TuMatch Inmobiliario
                </p>
                <div class="mt-4 flex items-center justify-center gap-2 text-gray-400 animate-fadeInUp" style="animation-delay: 0.4s;">
                    <div class="w-2 h-2 bg-brand-emerald rounded-full animate-pulse"></div>
                    <span class="text-sm font-medium">Sistema en tiempo real</span>
                </div>
            </div>
        </div>
        
        <!-- Bottom Border -->
        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-brand-coral via-brand-magenta to-brand-purple"></div>
    </header>

    <!-- Controls Section -->
    <div class="sticky top-0 z-50 bg-slate-800/80 backdrop-blur-xl border-b border-slate-700/50">
        <div class="max-w-7xl mx-auto px-6 py-6">
            <!-- Search and Filters -->
            <div class="flex flex-col lg:flex-row gap-4 mb-6">
                <div class="flex-1">
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white placeholder-gray-400 focus:border-brand-coral focus:ring-2 focus:ring-brand-coral/20 focus:outline-none transition-all duration-300"
                        placeholder="🔍 Buscar por corredor o código..."
                    >
                </div>
                <div class="lg:w-64">
                    <select class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-xl text-white focus:border-brand-magenta focus:ring-2 focus:ring-brand-magenta/20 focus:outline-none transition-all duration-300" id="corredorFilter">
                        <option value="">👥 Todos los corredores</option>
                    </select>
                </div>
                <button 
                    class="px-6 py-3 bg-gradient-to-r from-brand-coral to-brand-magenta text-white font-semibold rounded-xl hover:from-brand-magenta hover:to-brand-purple transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl flex items-center gap-2 justify-center"
                    onclick="loadData()"
                >
                    <span class="loading-spinner hidden">⟳</span>
                    <span>↻</span>
                    <span>Actualizar</span>
                </button>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-700/30 backdrop-blur-sm border border-slate-600/50 rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-brand-coral" id="totalCount">0</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide font-medium">Total</div>
                    <div class="w-full h-1 bg-gradient-to-r from-brand-coral to-brand-magenta rounded-full mt-2"></div>
                </div>
                <div class="bg-slate-700/30 backdrop-blur-sm border border-slate-600/50 rounded-xl p-4 text-center">
                    <div class="text-2xl font-bold text-brand-blue" id="visibleCount">0</div>
                    <div class="text-xs text-gray-400 uppercase tracking-wide font-medium">Mostrando</div>
                    <div class="w-full h-1 bg-gradient-to-r from-brand-blue to-brand-teal rounded-full mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Loading State -->
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="w-12 h-12 border-4 border-slate-600 border-t-brand-coral rounded-full animate-spin mb-4"></div>
            <p class="text-gray-400 font-medium">Cargando asignaciones...</p>
        </div>

        <!-- Properties Grid -->
        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 animate-fadeInUp" style="display: none;"></div>
        
        <!-- Status Footer -->
        <div class="flex items-center justify-center mt-12 py-6" id="lastUpdate">
            <div class="flex items-center gap-3 px-4 py-2 bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-full">
                <div class="w-2 h-2 bg-brand-emerald rounded-full animate-pulse"></div>
                <span class="text-sm text-gray-300 font-medium">Conectado</span>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="relative bg-gradient-to-br from-slate-900 via-slate-800 to-gray-900 mt-20">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-5">
            <div class="absolute top-10 left-20 w-20 h-20 bg-gradient-to-br from-brand-coral to-brand-magenta rounded-full"></div>
            <div class="absolute bottom-10 right-20 w-16 h-16 bg-gradient-to-br from-brand-blue to-brand-teal rounded-full"></div>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-24 h-24 bg-gradient-to-br from-brand-purple to-brand-rose rounded-full"></div>
        </div>
        
        <!-- Top Border -->
        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-brand-coral via-brand-magenta to-brand-purple"></div>
        
        <div class="relative z-10 max-w-7xl mx-auto px-6 py-16">
            <!-- Logo -->
            <div class="text-center mb-12">
                <h3 class="text-3xl font-bold mb-4 bg-gradient-to-r from-white to-gray-300 bg-clip-text text-transparent">
                    🏠 TuMatch Inmobiliario
                </h3>
            </div>
            
            <!-- Contact Info -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
                <div class="flex items-center justify-center gap-3 p-4 bg-slate-800/30 backdrop-blur-sm border border-slate-700/50 rounded-xl">
                    <span class="text-2xl">📧</span>
                    <a href="mailto:corretaje@tumatchinmobiliario.cl" class="text-gray-300 hover:text-brand-coral transition-colors duration-300">
                        corretaje@tumatchinmobiliario.cl
                    </a>
                </div>
                <div class="flex items-center justify-center gap-3 p-4 bg-slate-800/30 backdrop-blur-sm border border-slate-700/50 rounded-xl">
                    <span class="text-2xl">📱</span>
                    <a href="https://wa.me/56934107448" target="_blank" class="text-gray-300 hover:text-brand-emerald transition-colors duration-300">
                        +56 9 3410 7448
                    </a>
                </div>
                <div class="flex items-center justify-center gap-3 p-4 bg-slate-800/30 backdrop-blur-sm border border-slate-700/50 rounded-xl">
                    <span class="text-2xl">🕐</span>
                    <span class="text-gray-300">Lun-Vie 9:00-18:00</span>
                </div>
            </div>
            
            <!-- System Links -->
            <div class="flex flex-col md:flex-row gap-4 justify-center mb-12">
                <a href="https://backoffice.propital.com/#/login" target="_blank" 
                   class="px-6 py-3 bg-gradient-to-r from-brand-blue to-brand-teal text-white font-semibold rounded-xl hover:from-brand-teal hover:to-brand-emerald transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl text-center">
                    🔐 BackOffice Propital
                </a>
                <a href="https://app.2clics.cl/" target="_blank" 
                   class="px-6 py-3 bg-gradient-to-r from-brand-purple to-brand-rose text-white font-semibold rounded-xl hover:from-brand-rose hover:to-brand-coral transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl text-center">
                    📊 Sistema Multipublicador
                </a>
            </div>
            
        </div>
    </footer>

    <script>
        const SPREADSHEET_ID = '1X7cbk_fD5mGTXxs1cOa4tCxeXBrpiNWV4sEJnBRwVUM';
        const GID = '1154306850';
        
        let allData = [];
        let filteredData = [];
        let lastDataHash = '';
        let refreshInterval = 60000; // Intervalo inicial: 1 minuto (más conservador)
        let maxRefreshInterval = 300000; // Máximo: 5 minutos
        let consecutiveNoChanges = 0;
        let autoRefreshTimer = null;
        let isFirstLoad = true;
        
        // Cache para el XML de propiedades
        let xmlCache = {
            data: null,
            timestamp: 0,
            ttl: 24 * 60 * 60 * 1000, // 24 horas
            propertiesMap: new Map() // Mapa de reference_id -> imágenes
        };

        function getInitials(name) {
            if (!name) return '??';
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        // Función para crear hash de los datos
        function createDataHash(data) {
            return btoa(JSON.stringify(data.map(item => `${item.codigo}-${item.corredor}-${item.referido}-${item.firmaOrden}`).sort())).slice(0, 16);
        }

        // Función para comparar si los datos han cambiado
        function hasDataChanged(newData) {
            const newHash = createDataHash(newData);
            const changed = newHash !== lastDataHash;
            lastDataHash = newHash;
            
            // Ajustar intervalo basado en cambios
            if (changed) {
                consecutiveNoChanges = 0;
                refreshInterval = 60000; // Resetear a 1 minuto cuando hay cambios
            } else {
                consecutiveNoChanges++;
                // Incrementar intervalo gradualmente: 1m, 2m, 3m, 5m
                if (consecutiveNoChanges >= 2) {
                    refreshInterval = Math.min(maxRefreshInterval, refreshInterval * 1.5);
                }
            }
            
            return changed;
        }

        async function loadData(isAutoRefresh = false) {
            const loading = document.getElementById('loading');
            const grid = document.getElementById('grid');
            const refreshBtn = document.querySelector('.refresh-btn');
            
            // Si es autorefresh y ya hay datos, no mostrar loading
            if (!isAutoRefresh || allData.length === 0) {
                loading.style.display = 'flex';
                grid.style.display = 'none';
            }
            
            // Indicar que está cargando en el botón solo si no es autorefresh
            if (refreshBtn && !isAutoRefresh) {
                refreshBtn.innerHTML = `
                    <span class="loading-spinner animate-spin">⟳</span>
                    <span>Cargando...</span>
                `;
                refreshBtn.disabled = true;
            }

            try {
                const CSV_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${GID}`;
                
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                
                if (!csvText) {
                    throw new Error('No se pudo acceder a los datos. Verifica que la hoja sea pública.');
                }
                
                const lines = csvText.split('\n').filter(line => line.trim());
                
                if (lines.length === 0) {
                    throw new Error('No se encontraron datos en la hoja');
                }
                
                const newData = [];
                const corredores = new Set();

                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    
                    const codigo = values[1]?.trim() || '';
                    const corredor = values[4]?.trim() || '';
                    const referido = values[6]?.trim() || '';
                    const firmaOrden = values[7]?.trim() || '';
                    const estado = values[8]?.trim() || '';
                    
                    if (estado) continue;
                    if (!codigo || !corredor) continue;

                    const isTM = referido.toLowerCase().includes('francisco') && 
                                referido.toLowerCase().includes('garcia');

                    newData.push({
                        codigo: codigo,
                        corredor: corredor,
                        referido: isTM ? 'TuMatch' : (referido || 'Sin referido'),
                        firmaOrden: firmaOrden || 'Pendiente',
                        isTM: isTM
                    });

                    corredores.add(corredor);
                }

                // Solo actualizar si hay cambios reales
                if (!isAutoRefresh || hasDataChanged(newData)) {
                    allData = newData;
                    updateCorredorFilter(corredores);
                    
                    document.getElementById('lastUpdate').innerHTML = `
                        <div class="flex items-center gap-3 px-4 py-2 bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-full">
                            <div class="w-2 h-2 bg-brand-emerald rounded-full animate-pulse"></div>
                            <span class="text-sm text-gray-300 font-medium">Actualizado ${new Date().toLocaleTimeString('es-CL', {hour: '2-digit', minute: '2-digit'})}</span>
                        </div>
                    `;

                    await applyFilters();
                    
                    // Mostrar notificación sutil si es autorefresh y hay cambios
                    if (isAutoRefresh && allData.length > 0) {
                        showUpdateNotification();
                    }
                } else if (isAutoRefresh) {
                    // Solo actualizar la hora si no hay cambios
                    const nextCheck = Math.round(refreshInterval / 1000);
                    document.getElementById('lastUpdate').innerHTML = `
                        <div class="flex items-center gap-3 px-4 py-2 bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-full">
                            <div class="w-2 h-2 bg-brand-amber rounded-full animate-pulse"></div>
                            <span class="text-sm text-gray-300 font-medium">Sin cambios - próxima verificación en ${nextCheck}s</span>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error:', error);
                // Solo mostrar error si no hay datos previos
                if (allData.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-20 empty-state rounded-2xl">
                            <div class="text-6xl mb-6 opacity-50">⚠️</div>
                            <h2 class="text-2xl font-bold text-white mb-4">Error al cargar datos</h2>
                            <p class="text-gray-400 mb-6 max-w-md text-center">${error.message}</p>
                            <div class="bg-slate-700/50 p-6 rounded-xl border border-slate-600/50 max-w-md">
                                <p class="text-white font-semibold mb-3">Para solucionar:</p>
                                <ol class="text-sm text-gray-300 space-y-2 list-decimal list-inside">
                                    <li>Abre la hoja en Google Sheets</li>
                                    <li>Click en "Compartir"</li>
                                    <li>Selecciona "Cualquier persona con el enlace"</li>
                                    <li>Permisos de "Lector"</li>
                                    <li>Actualiza esta página</li>
                                </ol>
                            </div>
                        </div>
                    `;
                    grid.style.display = 'grid';
                }
            } finally {
                loading.style.display = 'none';
                if (refreshBtn && !isAutoRefresh) {
                    refreshBtn.innerHTML = `
                        <span>↻</span>
                        <span>Actualizar</span>
                    `;
                    refreshBtn.disabled = false;
                }
                
                // Asegurar que el grid se muestre si hay datos
                if (allData.length > 0) {
                    grid.style.display = 'grid';
                }
                
                // Iniciar auto-refresh solo después de la primera carga exitosa
                if (isFirstLoad) {
                    isFirstLoad = false;
                    scheduleNextRefresh();
                } else if (isAutoRefresh) {
                    scheduleNextRefresh();
                }
            }
        }

        // Función para programar el próximo refresh
        function scheduleNextRefresh() {
            if (autoRefreshTimer) {
                clearTimeout(autoRefreshTimer);
            }
            
            autoRefreshTimer = setTimeout(() => {
                loadData(true);
            }, refreshInterval);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function updateCorredorFilter(corredores) {
            const filterSelect = document.getElementById('corredorFilter');
            const currentValue = filterSelect.value;
            
            filterSelect.innerHTML = '<option value="">Todos los corredores</option>';
            
            Array.from(corredores).sort().forEach(corredor => {
                const option = document.createElement('option');
                option.value = corredor;
                option.textContent = corredor;
                filterSelect.appendChild(option);
            });
            
            filterSelect.value = currentValue;
        }

        async function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const corredorFilter = document.getElementById('corredorFilter').value;

            filteredData = allData.filter(item => {
                const matchesSearch = searchTerm === '' || 
                    item.corredor.toLowerCase().includes(searchTerm) ||
                    item.codigo.toLowerCase().includes(searchTerm);
                
                const matchesCorredor = corredorFilter === '' || item.corredor === corredorFilter;

                return matchesSearch && matchesCorredor;
            });

            await renderGrid();
            updateStats();
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = allData.length;
            document.getElementById('visibleCount').textContent = filteredData.length;
        }

        // Función para cargar y cachear el XML de propiedades
        async function loadXMLFeed() {
            const now = Date.now();
            
            // Verificar cache (24 horas)
            if (xmlCache.data && (now - xmlCache.timestamp < xmlCache.ttl)) {
                console.log('📋 Usando XML desde cache (válido por 24h)');
                return xmlCache.propertiesMap;
            }
            
            console.log('📋 Descargando XML feed de propiedades (actualización cada 24h)...');
            
            try {
                // URL del XML feed - usar proxy para evitar CORS
                const xmlUrl = 'https://2clicsalmcl.blob.core.windows.net/chile/xml/proppit/feed.xml';
                
                // Detectar si estamos en desarrollo local y usar proxy de Netlify
                const isLocalDevelopment = window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
                const isNetlifyDev = window.location.port === '8888';
                
                // SOLO usar función de Netlify para obtener XML real
                let fetchUrl;
                
                if (isLocalDevelopment) {
                    // En desarrollo local, usar función de Netlify
                    if (isNetlifyDev) {
                        fetchUrl = `/.netlify/functions/get-xml-feed`;
                        console.log('🌐 Usando función Netlify para XML real (netlify dev)');
                    } else {
                        // En desarrollo local sin netlify dev, no se puede acceder al XML
                        console.error('❌ No se puede acceder al XML desde localhost');
                        console.log('💡 Solución: ejecuta "netlify dev" o despliega en Netlify');
                        return xmlCache.propertiesMap; // Retornar cache vacío
                    }
                } else {
                    // En producción, usar función de Netlify
                    fetchUrl = `/.netlify/functions/get-xml-feed`;
                    console.log('🌐 Obteniendo XML real desde función Netlify');
                }
                
                const response = await fetch(fetchUrl);
                
                if (!response.ok) {
                    console.error('❌ Error descargando XML:', response.status);
                    return xmlCache.propertiesMap; // Retornar cache anterior si existe
                }
                
                const xmlText = await response.text();
                console.log(`📥 XML descargado: ${Math.round(xmlText.length / 1024)} KB`);
                
                if (!xmlText || xmlText.length < 1000) {
                    console.error('❌ XML muy pequeño o vacío:', xmlText.substring(0, 200));
                    return xmlCache.propertiesMap;
                }
                
                // Parsear XML
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Verificar errores de parseo
                const parserError = xmlDoc.querySelector('parsererror');
                if (parserError) {
                    console.error('❌ Error parseando XML:', parserError.textContent);
                    return xmlCache.propertiesMap;
                }
                
                // Limpiar mapa anterior
                xmlCache.propertiesMap.clear();
                
                // Obtener todas las propiedades (buscar por <listing>)
                const listings = xmlDoc.querySelectorAll('listing');
                console.log(`📊 Total de listings en XML: ${listings.length}`);
                
                if (listings.length === 0) {
                    console.error('❌ No se encontraron <listing> en el XML');
                    console.log('🔍 Estructura del XML:', xmlDoc.documentElement?.tagName, xmlDoc.documentElement?.children?.length);
                    return xmlCache.propertiesMap;
                }
                
                listings.forEach((listing, index) => {
                    try {
                        // Obtener Reference ID de la propiedad (maneja CDATA)
                        const referenceIdElement = listing.querySelector('reference_id');
                        if (!referenceIdElement) {
                            console.log(`⚠️ Listing ${index + 1}: Sin reference_id`);
                            return;
                        }
                        
                        // Obtener texto del reference_id (maneja CDATA automáticamente)
                        const referenceId = referenceIdElement.textContent.trim();
                        
                        if (!referenceId) {
                            console.log(`⚠️ Listing ${index + 1}: Reference_id vacío`);
                            return;
                        }
                        
                        // Obtener todas las imágenes desde <pictures><url>
                        const images = [];
                        const picturesElement = listing.querySelector('pictures');
                        
                        if (picturesElement) {
                            const urlElements = picturesElement.querySelectorAll('url');
                            urlElements.forEach(urlElement => {
                                const imageUrl = urlElement.textContent.trim();
                                if (imageUrl && imageUrl.startsWith('http')) {
                                    images.push(imageUrl);
                                }
                            });
                            
                            console.log(`📊 Listing ${index + 1} (ref: ${referenceId}): ${urlElements.length} URLs encontradas, ${images.length} válidas`);
                        } else {
                            console.log(`⚠️ Listing ${index + 1} (ref: ${referenceId}): Sin elemento <pictures>`);
                        }
                        
                        // Guardar en el mapa si hay imágenes válidas
                        if (images.length > 0) {
                            xmlCache.propertiesMap.set(referenceId, images);
                            console.log(`✅ Mapeado reference_id "${referenceId}" con ${images.length} imágenes`);
                        } else {
                            console.log(`❌ Listing ${index + 1} (ref: ${referenceId}): Sin imágenes válidas`);
                        }
                    } catch (err) {
                        console.error(`❌ Error procesando listing ${index + 1}:`, err);
                    }
                });
                
                // Actualizar cache
                xmlCache.data = xmlText;
                xmlCache.timestamp = now;
                
                console.log(`✅ XML cacheado con ${xmlCache.propertiesMap.size} propiedades con imágenes`);
                console.log(`🕐 Próxima actualización: ${new Date(now + xmlCache.ttl).toLocaleString()}`);
                
                // Log de rango de reference_ids para verificar que tenemos los números grandes
                const allIds = Array.from(xmlCache.propertiesMap.keys()).map(id => parseInt(id)).sort((a, b) => a - b);
                console.log(`📊 Rango de reference_ids: ${allIds[0]} - ${allIds[allIds.length - 1]}`);
                console.log(`📊 Incluye códigos TU grandes (>2000): ${allIds.filter(id => id > 2000).length} propiedades`);
                
                return xmlCache.propertiesMap;
                
            } catch (error) {
                console.error('❌ Error cargando XML feed:', error);
                return xmlCache.propertiesMap; // Retornar cache anterior si existe
            }
        }
        
        // Función principal para obtener imágenes desde XML feed (local)
        async function getPropertyImage(codigo) {
            try {
                // Extraer el reference_id del código (parte después de TU -)
                // Ejemplo: "TU -2917" → "2917"
                let referenceId = codigo.replace(/^TU\s*-\s*/, '').trim();
                
                // Si el código no tiene el formato TU-, tomar la parte final
                if (referenceId === codigo) {
                    referenceId = codigo.split('-').pop().trim();
                }
                
                console.log('🔍 Buscando imágenes para código:', codigo, '→ reference_id:', referenceId);
                
                // Cargar/obtener XML del cache (se actualiza cada 24h)
                const propertiesMap = await loadXMLFeed();
                
                // Log de cache status
                console.log(`📋 Cache contiene ${propertiesMap.size} reference_ids con imágenes`);
                
                // Buscar imágenes de esta propiedad por reference_id
                const images = propertiesMap.get(referenceId);
                
                if (images && images.length > 0) {
                    // Usar la primera imagen
                    const imageUrl = images[0];
                    console.log('✅ Imagen encontrada en XML:', {
                        codigo: codigo,
                        referenceId: referenceId,
                        url: imageUrl,
                        totalImages: images.length
                    });
                    
                    return imageUrl;
                } else {
                    console.log('❌ No se encontraron imágenes en XML para reference_id:', referenceId);
                    
                    // Log adicional para debugging - mostrar IDs disponibles
                    const availableIds = Array.from(propertiesMap.keys());
                    console.log('🔍 Total reference_ids en cache:', availableIds.length);
                    console.log('🔍 Reference_ids disponibles en XML:', availableIds.sort((a, b) => parseInt(a) - parseInt(b)));
                    
                    // Mostrar la diferencia entre lo que buscamos y lo que existe
                    console.log(`🔍 Buscando: ${referenceId} | Disponibles: ${availableIds.slice(0, 10).join(', ')}...`);
                    
                    return null;
                }
                
            } catch (error) {
                console.error('❌ Error obteniendo imagen:', error);
                return null;
            }
        }
        
        // Función fallback para imágenes placeholder
        function getPlaceholderImage(propertyId) {
            const placeholderUrls = [
                `https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=300&fit=crop&crop=center&auto=format&q=80`,
                `https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=400&h=300&fit=crop&crop=center&auto=format&q=80`,
                `https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=400&h=300&fit=crop&crop=center&auto=format&q=80`,
                `https://images.unsplash.com/photo-1512917774080-9991f1c4c750?w=400&h=300&fit=crop&crop=center&auto=format&q=80`,
                `https://images.unsplash.com/photo-1505843513577-22bb7d21e455?w=400&h=300&fit=crop&crop=center&auto=format&q=80`
            ];
            
            const randomIndex = parseInt(propertyId) % placeholderUrls.length;
            console.log('🖼️ Usando imagen placeholder para:', propertyId);
            return placeholderUrls[randomIndex];
        }
        

        async function renderGrid() {
            const grid = document.getElementById('grid');

            if (filteredData.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20 empty-state rounded-2xl">
                        <div class="text-6xl mb-6 opacity-50">🔍</div>
                        <h2 class="text-2xl font-bold text-white mb-2">Sin resultados</h2>
                        <p class="text-gray-400">No se encontraron asignaciones con estos filtros</p>
                    </div>
                `;
                grid.style.display = 'grid';
                return;
            }

            // Usar DocumentFragment para mejor rendimiento
            const fragment = document.createDocumentFragment();
            
            // Array de gradientes para variedad visual
            const gradients = [
                'icon-gradient-1', 'icon-gradient-2', 'icon-gradient-3', 
                'icon-gradient-4', 'icon-gradient-5', 'icon-gradient-6'
            ];
            
            // Crear todas las cards primero sin imágenes
            filteredData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'group relative bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-2xl overflow-hidden hover:border-brand-coral/70 transition-all duration-700 hover:transform hover:scale-110 hover:rotate-1 hover:shadow-2xl hover:shadow-brand-coral/30 animate-fadeInUp hover:z-10';
                card.style.animationDelay = `${index * 0.1}s`;
                
                const gradientClass = gradients[index % gradients.length];
                
                card.innerHTML = `
                    ${item.isTM ? `
                        <div class="absolute top-4 right-4 z-10">
                            <div class="px-3 py-1 bg-gradient-to-r from-brand-coral to-brand-magenta text-white text-xs font-bold rounded-full shadow-lg">
                                ✨ TuMatch
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Property Image -->
                    <div class="relative h-48 overflow-hidden property-image" data-codigo="${item.codigo}">
                        <div class="w-full h-full ${gradientClass} flex items-center justify-center text-white text-6xl animate-pulse">
                            🏠
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent"></div>
                    </div>
                    
                    <!-- Card Header -->
                    <div class="card-gradient p-6 relative overflow-hidden">
                        <!-- Background decoration -->
                        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-white/5 to-transparent rounded-full transform translate-x-16 -translate-y-16"></div>
                        
                        <div class="relative z-10 flex items-center space-x-4">
                            <div class="w-12 h-12 ${gradientClass} rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg">
                                ${getInitials(item.corredor)}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-lg text-white truncate">${item.corredor}</h3>
                                <p class="text-gray-300 text-sm font-medium uppercase tracking-wide">Corredor</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card Body -->
                    <div class="p-6 space-y-4">
                        <!-- Código de Propiedad -->
                        <div class="flex items-center space-x-4 p-4 bg-slate-700/30 rounded-xl border border-slate-600/50 hover:border-brand-coral/50 transition-all duration-300 group/item">
                            <div class="w-10 h-10 ${gradientClass} rounded-lg flex items-center justify-center text-white shadow-lg">
                                🏠
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-400 uppercase tracking-wide font-semibold mb-1">Código</p>
                                <a href="https://cl.fichapublica.com/pub/propiedad/${item.codigo.split('-').pop()}" 
                                   target="_blank" 
                                   rel="noopener noreferrer" 
                                   class="inline-flex items-center gap-2 text-brand-coral hover:text-brand-magenta font-bold transition-colors duration-300 group-hover/item:underline"
                                   title="Ver ficha pública">
                                    <span class="font-mono">${item.codigo}</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                        
                        <!-- Referido -->
                        <div class="flex items-center space-x-4 p-4 bg-slate-700/30 rounded-xl border border-slate-600/50 hover:border-brand-blue/50 transition-all duration-300">
                            <div class="w-10 h-10 ${gradients[(index + 1) % gradients.length]} rounded-lg flex items-center justify-center text-white shadow-lg">
                                👥
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-400 uppercase tracking-wide font-semibold mb-1">Referido</p>
                                <p class="text-white font-semibold truncate">${item.referido}</p>
                            </div>
                        </div>
                        
                        <!-- Captada por -->
                        <div class="flex items-center space-x-4 p-4 bg-slate-700/30 rounded-xl border border-slate-600/50 hover:border-brand-emerald/50 transition-all duration-300">
                            <div class="w-10 h-10 ${gradients[(index + 2) % gradients.length]} rounded-lg flex items-center justify-center text-white shadow-lg">
                                📝
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-xs text-gray-400 uppercase tracking-wide font-semibold mb-1">Captada por</p>
                                <p class="text-white font-semibold truncate">${item.firmaOrden}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                fragment.appendChild(card);
            });
            
            // Una sola operación DOM
            grid.innerHTML = '';
            grid.appendChild(fragment);
            grid.style.display = 'grid';
            
            // Cargar imágenes de propiedades de forma asíncrona
            loadPropertyImages();
        }
        

        // Función para cargar imágenes de propiedades después de renderizar
        async function loadPropertyImages() {
            const imageContainers = document.querySelectorAll('.property-image');
            
            console.log(`🖼️ Iniciando carga de imágenes para ${imageContainers.length} propiedades`);
            
            for (let container of imageContainers) {
                const codigo = container.dataset.codigo;
                let imageLoaded = false;
                
                try {
                    // Obtener imagen desde XML feed
                    console.log('🔍 Buscando imagen en XML para:', codigo);
                    const imageUrl = await getPropertyImage(codigo);
                    
                    if (imageUrl) {
                        // Cargar imagen encontrada en XML
                        console.log('📥 Intentando cargar imagen:', imageUrl);
                        imageLoaded = await tryLoadImage(container, imageUrl, codigo);
                        if (imageLoaded) {
                            console.log('✅ Imagen XML cargada para:', codigo);
                        } else {
                            console.log('❌ Error cargando imagen URL para:', codigo);
                        }
                    } else {
                        console.log('🏠 Sin imagen en XML para:', codigo, '- manteniendo icono');
                    }
                    
                    // Si no hay imagen, mantener el icono de casa (quitar animación)
                    if (!imageLoaded) {
                        const placeholder = container.querySelector('div');
                        if (placeholder) {
                            placeholder.classList.remove('animate-pulse');
                            placeholder.innerHTML = '🏠';
                            placeholder.classList.add('text-gray-400');
                        }
                    }
                    
                } catch (error) {
                    console.error('❌ Error cargando imagen para', codigo, ':', error);
                    const placeholder = container.querySelector('div');
                    if (placeholder) {
                        placeholder.classList.remove('animate-pulse');
                    }
                }
            }
            
            console.log('🖼️ Carga de imágenes completada');
        }

        // Función helper para intentar cargar una imagen específica
        function tryLoadImage(container, imageUrl, codigo) {
            return new Promise((resolve) => {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = `Propiedad ${codigo}`;
                img.className = 'absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-110';
                img.style.opacity = '0';
                img.style.zIndex = '10'; // Asegurar que esté sobre el placeholder
                
                img.onload = () => {
                    console.log('✅ Imagen cargada exitosamente:', imageUrl);
                    
                    // Agregar la imagen PRIMERO (antes de animar)
                    container.appendChild(img);
                    
                    // Fade in la imagen
                    setTimeout(() => {
                        img.style.transition = 'opacity 0.5s ease-in-out';
                        img.style.opacity = '1';
                    }, 50);
                    
                    // Remover el placeholder DESPUÉS de que la imagen sea visible
                    setTimeout(() => {
                        const placeholder = container.querySelector('div');
                        if (placeholder) {
                            placeholder.style.transition = 'opacity 0.3s ease-out';
                            placeholder.style.opacity = '0';
                            setTimeout(() => {
                                if (placeholder.parentNode) {
                                    placeholder.remove();
                                }
                            }, 300);
                        }
                    }, 200);
                    
                    resolve(true);
                };
                
                img.onerror = () => {
                    console.log('❌ Error cargando imagen:', imageUrl);
                    resolve(false);
                };
                
                // Timeout después de 5 segundos
                setTimeout(() => {
                    if (img.complete === false) {
                        console.log('⏱️ Timeout cargando imagen:', imageUrl);
                        resolve(false);
                    }
                }, 5000);
            });
        }

        // Función para mostrar notificación de actualización
        function showUpdateNotification() {
            // Crear notificación si no existe
            let notification = document.querySelector('.update-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.className = 'update-notification';
                notification.innerHTML = `
                    <span>✓</span>
                    <span>Datos actualizados</span>
                `;
                document.body.appendChild(notification);
            }
            
            // Mostrar notificación
            notification.classList.add('show');
            
            // Ocultar después de 3 segundos
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Event listeners con debounce para búsqueda
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 150);
        });
        
        document.getElementById('corredorFilter').addEventListener('change', applyFilters);

        // Cargar datos inicialmente
        loadData();
    </script>
</body>
</html>