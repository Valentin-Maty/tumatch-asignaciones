<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test XML Feed de Im√°genes</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">üß™ Test XML Feed de Im√°genes</h1>
        
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Probar b√∫squeda de im√°genes</h2>
            <div class="flex gap-4">
                <input 
                    type="text" 
                    id="propertyId" 
                    placeholder="Reference ID (ej: 11, 2950)"
                    class="flex-1 px-4 py-2 bg-gray-700 rounded border border-gray-600 text-white"
                    value="11"
                >
                <button 
                    onclick="testXML()"
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded font-semibold transition"
                >
                    Buscar en XML
                </button>
            </div>
        </div>

        <div id="loading" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
            <p class="mt-4">Consultando XML feed...</p>
        </div>

        <div id="results" class="space-y-6"></div>
    </div>

    <script>
        // Cache para el XML de propiedades (mismo que en index.html)
        let xmlCache = {
            data: null,
            timestamp: 0,
            ttl: 24 * 60 * 60 * 1000, // 24 horas
            propertiesMap: new Map() // Mapa de reference_id -> im√°genes
        };

        // Funci√≥n para cargar y cachear el XML de propiedades (mismo que en index.html)
        async function loadXMLFeed() {
            const now = Date.now();
            
            // Verificar cache
            if (xmlCache.data && (now - xmlCache.timestamp < xmlCache.ttl)) {
                console.log('üìã Usando XML desde cache');
                return xmlCache.propertiesMap;
            }
            
            console.log('üìã Descargando XML feed de propiedades...');
            
            try {
                // URL del XML feed
                const xmlUrl = 'https://2clicsalmcl.blob.core.windows.net/chile/xml/proppit/feed.xml';
                
                const response = await fetch(xmlUrl);
                
                if (!response.ok) {
                    console.error('‚ùå Error descargando XML:', response.status);
                    return xmlCache.propertiesMap; // Retornar cache anterior si existe
                }
                
                const xmlText = await response.text();
                
                // Parsear XML
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Verificar errores de parseo
                const parserError = xmlDoc.querySelector('parsererror');
                if (parserError) {
                    console.error('‚ùå Error parseando XML:', parserError.textContent);
                    return xmlCache.propertiesMap;
                }
                
                // Limpiar mapa anterior
                xmlCache.propertiesMap.clear();
                
                // Obtener todas las propiedades (buscar por <listing>)
                const listings = xmlDoc.querySelectorAll('listing');
                console.log(`üìä Total de listings en XML: ${listings.length}`);
                
                listings.forEach(listing => {
                    try {
                        // Obtener Reference ID de la propiedad
                        const referenceIdElement = listing.querySelector('reference_id');
                        if (!referenceIdElement) return;
                        
                        const referenceId = referenceIdElement.textContent.trim();
                        
                        // Obtener todas las im√°genes desde <pictures><url>
                        const images = [];
                        const picturesElement = listing.querySelector('pictures');
                        
                        if (picturesElement) {
                            const urlElements = picturesElement.querySelectorAll('url');
                            urlElements.forEach(urlElement => {
                                const imageUrl = urlElement.textContent.trim();
                                if (imageUrl) {
                                    images.push(imageUrl);
                                }
                            });
                        }
                        
                        // Guardar en el mapa si hay im√°genes
                        if (images.length > 0) {
                            xmlCache.propertiesMap.set(referenceId, images);
                        }
                    } catch (err) {
                        console.error('Error procesando listing:', err);
                    }
                });
                
                // Actualizar cache
                xmlCache.data = xmlText;
                xmlCache.timestamp = now;
                
                console.log(`‚úÖ XML cacheado con ${xmlCache.propertiesMap.size} propiedades con im√°genes`);
                
                return xmlCache.propertiesMap;
                
            } catch (error) {
                console.error('‚ùå Error cargando XML feed:', error);
                return xmlCache.propertiesMap; // Retornar cache anterior si existe
            }
        }

        async function testXML() {
            const referenceId = document.getElementById('propertyId').value.trim();
            if (!referenceId) {
                alert('Por favor ingresa un Reference ID');
                return;
            }

            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            
            loading.classList.remove('hidden');
            results.innerHTML = '';

            try {
                // Test directo al XML (m√©todo local)
                console.log('üìã Probando XML feed LOCAL para reference_id:', referenceId);
                
                // Cargar XML desde el frontend
                const propertiesMap = await loadXMLFeed();
                
                // Buscar im√°genes de esta propiedad por reference_id
                const images = propertiesMap.get(referenceId);
                
                let html = `
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Resultados para Reference ID: ${referenceId}</h3>
                        <div class="space-y-2 mb-4">
                            <p><span class="text-gray-400">Estado:</span> ${images && images.length > 0 ? '‚úÖ √âxito' : '‚ùå No encontrado'}</p>
                            <p><span class="text-gray-400">Total de im√°genes:</span> ${images ? images.length : 0}</p>
                            <p><span class="text-gray-400">Fuente:</span> XML local (pictures/url) - Cache 24h</p>
                            <p><span class="text-gray-400">Total reference_ids en cache:</span> ${propertiesMap.size}</p>
                        </div>
                `;
                
                if (images && images.length > 0) {
                    html += '<div class="grid grid-cols-2 gap-4">';
                    
                    images.forEach((imageUrl, index) => {
                        html += `
                            <div class="bg-gray-700 rounded-lg p-4">
                                <p class="text-sm text-gray-400 mb-2">Imagen ${index + 1}</p>
                                <img 
                                    src="${imageUrl}" 
                                    alt="Imagen ${index + 1}"
                                    class="w-full h-48 object-cover rounded mb-2"
                                    onerror="this.src='https://via.placeholder.com/400x300/1a1a1a/ffffff?text=Error'"
                                >
                                <div class="text-xs text-gray-400 break-all">
                                    <p class="mb-1"><strong>URL:</strong></p>
                                    <p class="font-mono">${imageUrl}</p>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                } else {
                    html += `
                        <div class="bg-yellow-900/20 border border-yellow-600 rounded-lg p-4">
                            <p class="text-yellow-400">‚ö†Ô∏è No se encontraron im√°genes para reference_id ${referenceId} en el XML</p>
                            <p class="text-sm text-gray-400 mt-2">Reference IDs disponibles: ${Array.from(propertiesMap.keys()).slice(0, 5).join(', ')}${propertiesMap.size > 5 ? '...' : ''}</p>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                results.innerHTML = html;
                
            } catch (error) {
                console.error('Error:', error);
                results.innerHTML = `
                    <div class="bg-red-900/20 border border-red-600 rounded-lg p-4">
                        <p class="text-red-400 font-semibold mb-2">Error de conexi√≥n:</p>
                        <p class="font-mono text-sm">${error.message}</p>
                        <p class="mt-2 text-gray-400">El XML se descarga directamente desde el frontend - no necesita servidor local</p>
                    </div>
                `;
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Test autom√°tico al cargar
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üîß P√°gina de test cargada');
            console.log('üìç URL base:', window.location.origin);
            console.log('üåê M√©todo: XML directo desde frontend (sin Netlify Functions)');
        });
    </script>
</body>
</html>